<!DOCTYPE html>
<html>
<head>
    <title>KPI Automation Test</title>
</head>
<body>
    <h1>KPI Automation Test</h1>
    <button onclick="runTest()">Test Monday.com to Notion Sync</button>
    <div id="output" style="margin-top: 20px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
        <p>Click the button above to test the automation</p>
    </div>

    <script>
        const config = {
            notion: {
                apiKey: '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',
                projectDatabaseId: '210d2a8e647580859738000cd4f2a77b',
                kpiDatabaseId: '210d2a8e6475802fb688000c9aca221d',
                employeeDatabaseId: '210d2a8e647580bfafaf000c5f54d49e'
            },
            monday: {
                apiKey: 'eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjUxOTA2NDk1OCwiYWFpIjoxMSwidWlkIjozNzIyNDA3OCwiaWFkIjoiMjAyNS0wNS0yOFQxODoyNDo0My4wMDBaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6NzEwNzc1MywicmduIjoidXNlMSJ9.RzznXXwJHT-O8LDwRReVfYPdw9pBHhpPDpYHSapsgoM'
            }
        };

        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

      async function testMondayConnection() {
    log('üîç Testing Monday.com connection...');
    
    const query = `
        query {
            boards(limit: 5) {
                name
                id
                items_page {
                    items {
                        id
                        name
                        state
                        created_at
                        updated_at
                    }
                }
            }
        }
    `;

    try {
        const response = await fetch('https://api.monday.com/v2', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': config.monday.apiKey
            },
            body: JSON.stringify({ query })
        });

        const data = await response.json();
        
        if (data.errors) {
            log('‚ùå Monday.com Error: ' + JSON.stringify(data.errors));
            return null;
        }
        
        let totalItems = 0;
        let completedItems = 0;
        
        data.data.boards.forEach(board => {
            const items = board.items_page.items;
            totalItems += items.length;
            
            // Count completed items based on state
            completedItems += items.filter(item => 
                item.state === 'done' || item.state === 'complete'
            ).length;
            
            log('üìã Board: ' + board.name + ' (' + items.length + ' items)');
        });
        
        const completionRate = totalItems > 0 ? ((completedItems / totalItems) * 100).toFixed(1) : 0;
        
        log('‚úÖ Monday.com connected!');
        log('üìä Found ' + data.data.boards.length + ' boards with ' + totalItems + ' total tasks');
        log('üìà Completion rate: ' + completionRate + '% (' + completedItems + '/' + totalItems + ' completed)');
        
        return {
            data: data.data,
            metrics: {
                totalTasks: totalItems,
                completedTasks: completedItems,
                completionRate: parseFloat(completionRate)
            }
        };
    } catch (error) {
        log('‚ùå Monday.com connection failed: ' + error.message);
        return null;
    }
}

        async function testNotionConnection() {
            log('üîç Testing Notion connection...');
            
            const testProject = {
                'Name': {
                    title: [{ text: { content: 'Test Project from Monday.com - ' + new Date().toLocaleString() } }]
                },
                'Monday.com Task ID': {
                    rich_text: [{ text: { content: 'TEST-' + Date.now() } }]
                },
                'Project Type': {
                    select: { name: 'New Site' }
                },
                'Platform': {
                    select: { name: 'WordPress' }
                },
                'Status': {
                    select: { name: 'In Progress' }
                },
                'Start Date': {
                    date: { start: '2025-06-12' }
                },
                'Target Completion': {
                    date: { start: '2025-06-19' }
                }
            };

            try {
                const response = await fetch('https://api.notion.com/v1/pages', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.notion.apiKey}`,
                        'Content-Type': 'application/json',
                        'Notion-Version': '2022-06-28'
                    },
                    body: JSON.stringify({
                        parent: { database_id: config.notion.projectDatabaseId },
                        properties: testProject
                    })
                });

                const data = await response.json();
                
                if (data.object === 'error') {
                    log('‚ùå Notion Error: ' + data.message);
                    return null;
                }
                
                log('‚úÖ Notion connected! Test project created successfully');
                return data;
            } catch (error) {
                log('‚ùå Notion connection failed: ' + error.message);
                return null;
            }
        }

       async function runTest() {
    const output = document.getElementById('output');
    output.innerHTML = '<h3>Running Automation Test...</h3>';
    
    log('üöÄ Starting Monday.com to Notion automation test...');
    
    // Test Monday.com
    const mondayResult = await testMondayConnection();
    
    if (!mondayResult) {
        log('‚ùå Cannot proceed without Monday.com connection');
        return;
    }
    
    // Test Notion
    const notionResult = await testNotionConnection();
    
    if (!notionResult) {
        log('‚ùå Cannot proceed without Notion connection');
        return;
    }
    
    // Update KPI database with Monday.com metrics
    if (mondayResult.metrics) {
        log('üìù Updating KPI database with task metrics...');
        await updateKPIDatabase(mondayResult.metrics);
    }
    
    log('üéâ Test completed successfully!');
    log('üìä Check your Notion databases for new entries');
}

        async function updateKPIDatabase(metrics) {
    const kpiEntry = {
        'Date': {
            date: { start: new Date().toISOString().split('T')[0] }
        },
        'Platform Uptime': {
            number: 99.95
        },
        'Avg Load Time': {
            number: 2.1
        },
        'Core Web Vitals Score': {
            number: 94
        },
        'Sites Monitored': {
            number: 25
        },
        'Data Source': {
            select: { name: 'Automated API' }
        },
        'Notes': {
            rich_text: [{
                text: {
                    content: `Monday.com sync: ${metrics.totalTasks} total tasks, ${metrics.completionRate}% completion rate. Generated at ${new Date().toLocaleString()}`
                }
            }]
        }
    };

    try {
        const response = await fetch('https://api.notion.com/v1/pages', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${config.notion.apiKey}`,
                'Content-Type': 'application/json',
                'Notion-Version': '2022-06-28'
            },
            body: JSON.stringify({
                parent: { database_id: config.notion.kpiDatabaseId },
                properties: kpiEntry
            })
        });

        const data = await response.json();
        
        if (data.object === 'error') {
            log('‚ùå KPI Database Error: ' + data.message);
            return null;
        }
        
        log('‚úÖ KPI database updated with Monday.com metrics');
        return data;
    } catch (error) {
        log('‚ùå KPI update failed: ' + error.message);
        return null;
    }
}
    </script>
</body>
</html>
