<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completed Website Projects Metrics - Live Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .metric-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Completed Website Projects Metrics - Live Data</h1>
            <p class="text-gray-600">Real-time analysis from Supabase database</p>
            <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-700">
                    <strong>âœ… Live Data:</strong> Connected to Supabase database with real metrics from Monday.com sync.
                </p>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="metric-card text-center">
                <div class="text-3xl font-bold text-blue-600" id="totalProjects">-</div>
                <div class="text-sm text-gray-500">Total Completed</div>
            </div>
            <div class="metric-card text-center">
                <div class="text-3xl font-bold text-green-600" id="newBuilds">-</div>
                <div class="text-sm text-gray-500">New Builds</div>
            </div>
            <div class="metric-card text-center">
                <div class="text-3xl font-bold text-purple-600" id="withData">-</div>
                <div class="text-sm text-gray-500">With Metrics</div>
            </div>
            <div class="metric-card text-center">
                <div class="text-3xl font-bold text-orange-600" id="monthsActive">-</div>
                <div class="text-sm text-gray-500">Active Months</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Completion Trends -->
            <div class="metric-card">
                <h3 class="text-lg font-semibold mb-4">Monthly Completion Trends</h3>
                <div class="loading" id="completionLoading">Loading...</div>
                <canvas id="completionChart" style="display: none;"></canvas>
            </div>

            <!-- Project Types -->
            <div class="metric-card">
                <h3 class="text-lg font-semibold mb-4">Project Types Distribution</h3>
                <div class="loading" id="typesLoading">Loading...</div>
                <canvas id="typesChart" style="display: none;"></canvas>
            </div>

            <!-- Duration Chart -->
            <div class="metric-card">
                <h3 class="text-lg font-semibold mb-4">Average Duration by Month (Days)</h3>
                <div class="loading" id="durationLoading">Loading...</div>
                <canvas id="durationChart" style="display: none;"></canvas>
                <div id="noDurationData" style="display: none;" class="text-center text-gray-500 py-8">
                    No duration data available
                </div>
            </div>

            <!-- QC Score Chart -->
            <div class="metric-card">
                <h3 class="text-lg font-semibold mb-4">Average QC Score by Month</h3>
                <div class="loading" id="qcLoading">Loading...</div>
                <canvas id="qcChart" style="display: none;"></canvas>
                <div id="noQCData" style="display: none;" class="text-center text-gray-500 py-8">
                    No QC score data available
                </div>
            </div>
        </div>

        <!-- Recent Projects List -->
        <div class="metric-card mt-6">
            <h3 class="text-lg font-semibold mb-4">Recent Completed Projects with Metrics</h3>
            <div id="projectsList" class="space-y-2">
                <div class="loading">Loading projects...</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase (replace with your actual keys)
        const SUPABASE_URL = 'https://mllfspslwvqddnffdqft.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sbGZzcHNsd3ZxZGRuZmZkcWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzNzMwODMsImV4cCI6MjA0OTk0OTA4M30.9eHVKNBAz_GS2KzYh2xKCpfV7w3lk-OOBY3FVHP8o6M';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allProjects = [];

        async function loadData() {
            try {
                const { data: projects, error } = await supabase
                    .from('website_projects')
                    .select('name, task_type, actual_completion_date, total_duration_hours, qc_review_score')
                    .eq('current_phase', 'Completed')
                    .order('actual_completion_date', { ascending: false });

                if (error) {
                    console.error('Error loading data:', error);
                    return;
                }

                allProjects = projects;
                initializeCharts();
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        function initializeCharts() {
            // Update summary stats
            const totalProjects = allProjects.length;
            const newBuilds = allProjects.filter(p => p.task_type === 'New Build').length;
            const withMetrics = allProjects.filter(p => p.total_duration_hours || p.qc_review_score).length;

            // Calculate months active
            const months = [...new Set(allProjects.map(p => p.actual_completion_date?.substring(0, 7)).filter(Boolean))];

            document.getElementById('totalProjects').textContent = totalProjects;
            document.getElementById('newBuilds').textContent = newBuilds;
            document.getElementById('withData').textContent = withMetrics;
            document.getElementById('monthsActive').textContent = months.length;

            // Create charts
            createCompletionChart();
            createTypesChart();
            createDurationChart();
            createQCChart();
            showRecentProjects();
        }

        function createCompletionChart() {
            const monthCounts = {};
            allProjects.forEach(project => {
                if (project.actual_completion_date) {
                    const month = project.actual_completion_date.substring(0, 7);
                    monthCounts[month] = (monthCounts[month] || 0) + 1;
                }
            });

            const sortedMonths = Object.keys(monthCounts).sort();
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            const ctx = document.getElementById('completionChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Projects Completed',
                        data: sortedMonths.map(month => monthCounts[month]),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            document.getElementById('completionLoading').style.display = 'none';
            document.getElementById('completionChart').style.display = 'block';
        }

        function createTypesChart() {
            const newBuilds = allProjects.filter(p => p.task_type === 'New Build').length;
            const rebuilds = allProjects.filter(p => p.task_type === 'Rebuild').length;

            const ctx = document.getElementById('typesChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['New Build', 'Rebuild'],
                    datasets: [{
                        data: [newBuilds, rebuilds],
                        backgroundColor: ['#10B981', '#8B5CF6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            document.getElementById('typesLoading').style.display = 'none';
            document.getElementById('typesChart').style.display = 'block';
        }

        function createDurationChart() {
            // Group projects by month and calculate average duration
            const monthlyDuration = {};
            allProjects.forEach(project => {
                if (project.actual_completion_date && project.total_duration_hours) {
                    const month = project.actual_completion_date.substring(0, 7);
                    if (!monthlyDuration[month]) {
                        monthlyDuration[month] = { total: 0, count: 0 };
                    }
                    monthlyDuration[month].total += project.total_duration_hours;
                    monthlyDuration[month].count += 1;
                }
            });

            if (Object.keys(monthlyDuration).length === 0) {
                document.getElementById('durationLoading').style.display = 'none';
                document.getElementById('noDurationData').style.display = 'block';
                return;
            }

            const sortedMonths = Object.keys(monthlyDuration).sort();
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            // Convert hours to days (assuming 8-hour work days)
            const avgDurations = sortedMonths.map(month => {
                const avgHours = monthlyDuration[month].total / monthlyDuration[month].count;
                return Math.round((avgHours / 8) * 10) / 10; // Convert to days, round to 1 decimal
            });

            const ctx = document.getElementById('durationChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Duration (days)',
                        data: avgDurations,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: '#22C55E',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Days (8h work days)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const days = context.parsed.y;
                                    const hours = days * 8;
                                    return `${days} days (${hours}h)`;
                                }
                            }
                        }
                    }
                }
            });

            document.getElementById('durationLoading').style.display = 'none';
            document.getElementById('durationChart').style.display = 'block';
        }

        function createQCChart() {
            // Group projects by month and calculate average QC score
            const monthlyQC = {};
            allProjects.forEach(project => {
                if (project.actual_completion_date && project.qc_review_score) {
                    const month = project.actual_completion_date.substring(0, 7);
                    if (!monthlyQC[month]) {
                        monthlyQC[month] = { total: 0, count: 0 };
                    }
                    monthlyQC[month].total += project.qc_review_score;
                    monthlyQC[month].count += 1;
                }
            });

            if (Object.keys(monthlyQC).length === 0) {
                document.getElementById('qcLoading').style.display = 'none';
                document.getElementById('noQCData').style.display = 'block';
                return;
            }

            const sortedMonths = Object.keys(monthlyQC).sort();
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            const avgQCScores = sortedMonths.map(month =>
                monthlyQC[month].total / monthlyQC[month].count
            );

            const ctx = document.getElementById('qcChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average QC Score',
                        data: avgQCScores,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            title: {
                                display: true,
                                text: 'QC Score (scaled 1-10)'
                            }
                        }
                    }
                }
            });

            document.getElementById('qcLoading').style.display = 'none';
            document.getElementById('qcChart').style.display = 'block';
        }

        function showRecentProjects() {
            const projectsWithData = allProjects
                .filter(p => p.total_duration_hours || p.qc_review_score)
                .sort((a, b) => new Date(b.actual_completion_date) - new Date(a.actual_completion_date))
                .slice(0, 10);

            if (projectsWithData.length === 0) {
                document.getElementById('projectsList').innerHTML =
                    '<div class="text-center text-gray-500 py-8">No projects with metrics data found</div>';
                return;
            }

            const projectsHTML = projectsWithData.map(project => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <div class="font-medium">${project.name}</div>
                        <div class="text-sm text-gray-500">${project.task_type}</div>
                    </div>
                    <div class="text-right text-sm">
                        <div class="text-gray-600">
                            ${new Date(project.actual_completion_date).toLocaleDateString()}
                        </div>
                        <div class="text-gray-500">
                            ${project.total_duration_hours ? Math.round((project.total_duration_hours / 8) * 10) / 10 + ' days' : ''}
                            ${project.qc_review_score ? 'QC: ' + project.qc_review_score : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('projectsList').innerHTML = projectsHTML;
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>